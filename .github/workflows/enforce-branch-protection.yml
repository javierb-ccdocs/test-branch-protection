name: Enforce Branch Protection

# Run when PRs are created or updated
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: # Allow manual trigger

jobs:
  enforce-protection:
    name: Enforce Branch Protection
    runs-on: ubuntu-latest
    steps:
      - name: Check PRs and close if checks fail
        uses: actions/github-script@v6
        with:
          script: |
            // If triggered by PR event, check if PR is already closed first
            if (context.eventName === 'pull_request') {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              
              // Exit early if already closed (prevents failure emails)
              if (pr.state === 'closed') {
                console.log('â„¹ï¸ PR already closed - exiting early to avoid duplicate emails');
                process.exit(0);
              }
            }
            
            let prsToCheck = [];
            
            // Check the PR that triggered this workflow
            if (context.eventName === 'pull_request') {
              prsToCheck = [context.payload.pull_request];
            } else {
              // Manual trigger - check all open PRs targeting main/staging/develop
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              prsToCheck = prs.filter(pr => 
                pr.base.ref === 'main' || pr.base.ref === 'staging' || pr.base.ref === 'develop'
              );
            }
            
            for (const pr of prsToCheck) {
              // Skip draft PRs
              if (pr.draft) {
                console.log(`Skipping draft PR #${pr.number}`);
                continue;
              }
              
              // Check if PR is already closed (likely by PR Validation)
              const { data: currentPr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              });
              
              // Skip if already closed to avoid duplicate comments
              if (currentPr.state === 'closed') {
                console.log(`PR #${pr.number} already closed - skipping to avoid duplicate comments`);
                continue;
              }
              
              // Get latest commit status
              const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
              });
              
              // Required checks
              const requiredChecks = [
                'CodeRabbit',
                'deploy',
                'Lint and Build',
                'Docker Build Test',
                'Required Checks / lint',
                'Required Checks / test',
                'Required Checks / build',
                'PR Validation / validate-pr'
              ];
              
              // Check which checks have passed/failed
              const checkResults = {};
              requiredChecks.forEach(check => {
                const status = statuses.find(s => s.context === check);
                if (status) {
                  checkResults[check] = status.state;
                } else {
                  checkResults[check] = 'pending';
                }
              });
              
              const failedChecks = Object.entries(checkResults)
                .filter(([check, state]) => state === 'failure' || state === 'error')
                .map(([check]) => check);
              
              const pendingChecks = Object.entries(checkResults)
                .filter(([check, state]) => state === 'pending')
                .map(([check]) => check);
              
              // Only act if all checks are complete (no pending)
              if (pendingChecks.length > 0) {
                console.log(`PR #${pr.number} - waiting for checks: ${pendingChecks.join(', ')}`);
                continue;
              }
              
              // All checks completed
              if (failedChecks.length > 0) {
                // Double-check PR is still open (might have been closed by PR Validation)
                const { data: currentPr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                });
                
                // Only close and comment if PR is still open (not already closed by PR Validation)
                if (currentPr.state === 'open') {
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    state: 'closed'
                  });
                  
                  // ONE concise comment
                  const failedList = failedChecks.map(c => `- ${c}`).join('\n');
                  await github.rest.issues.createComment({
                    issue_number: pr.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `ðŸš« **PR Closed - Checks Failed**\n\nFailed: ${failedChecks.length} check(s)\n\n${failedList}\n\nFix and push new commits to reopen.`
                  });
                  
                  console.log(`Closed PR #${pr.number} - checks failed`);
                }
              } else {
                // All checks passed - silently reopen if needed
                const { data: currentPr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                });
                
                if (currentPr.state === 'closed' && currentPr.merged === false) {
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    state: 'open'
                  });
                  console.log(`Reopened PR #${pr.number} - all checks passed`);
                }
              }
            }

